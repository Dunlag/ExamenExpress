<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap');
        body{

        }
        </style>
</head>
<body>
    <%- include('partials/header') %>
    <div class="container mt-4">
        <h1 class="mb-4"><%= title %></h1>

        <button id="addMovieBtn" class="btn btn-success mb-3">Añadir Película</button>

        <table id="moviesTable" class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Título</th>
                    <th>Género</th>
                    <th>Año</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <%- include('partials/footer') %>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <script>
        $(document).ready(function () {
            let table = $('#moviesTable').DataTable({
                ajax: '/api/peliculas',
                columns: [
                    { data: 'id' },
                    { data: 'titulo' },
                    { data: 'genero' },
                    { data: 'anio' },
                    {
                        data: null,
                        render: function (data, type, row) {
                            return `<button class="btn btn-danger btn-sm delete-btn" data-id="${row.id}">Eliminar</button>`;
                        }
                    }
                ]
            });

            // Añadir película
            $('#addMovieBtn').on('click', function () {
                Swal.fire({
                    title: 'Añadir Película',
                    html: `
                        <input id="swal-title" class="swal2-input" placeholder="Título">
                        <input id="swal-genero" class="swal2-input" placeholder="Género">
                        <input id="swal-anio" class="swal2-input" type="number" placeholder="Año">
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Añadir',
                    preConfirm: () => {
                        let titulo = document.getElementById('swal-title').value;
                        let genero = document.getElementById('swal-genero').value;
                        let anio = document.getElementById('swal-anio').value;

                        if (!titulo || !genero || !anio) {
                            Swal.showValidationMessage('Todos los campos son obligatorios');
                        }
                        return { titulo, genero, anio };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.post('/api/peliculas', result.value, function () {
                            table.ajax.reload();
                            Swal.fire('Éxito', 'Película añadida', 'success');
                        });
                    }
                });
            });

            // Eliminar película
            $('#moviesTable tbody').on('click', '.delete-btn', function () {
                let id = $(this).data('id');
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "Esta acción no se puede deshacer",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `/api/peliculas/${id}`,
                            type: 'DELETE',
                            success: function () {
                                table.ajax.reload();
                                Swal.fire('Eliminado', 'Película eliminada', 'success');
                            }
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>

